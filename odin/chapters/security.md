# Security architecture

## Requirements

### Epics:
1. **I**ntegrity
2. **S**ecrecy
3. **A**nonymity

### Functional

- (I-ds) Digital signatures can be added to deltas
- (I-gen) A signing certificate can be generated by the user while offline
- (I-mod) Moderation mechanism to revoke trust
- (S-enc) Sharing secrets via encryption
- (S-mt) Shared secrets propagate only via machines trusted by those included in the secret
- (A-p) Partial Identities
- (A-or) Onion Routing

| Requirement | Value | Effort |
| -- | -- | -- |
| I-ds |  |  |
| I-gen |  |  |
| S-enc |  |  |
| S-mt |  |  |
| A-p |  |  |
| A-or |  |  |


### Non-functional

# Architecture

Main flows:
- User registration (create a new user-identity certificate that is signed by an Odin CA after an OpenID authentication flow)
- Hub trust setup (Enable a hub to download and use the user-identity certificate to spawn user-sessions)
- Client session setup (Create a certificate signed by the user-identity certificate for mutation/edit/change signatures on-expiry/client-authentication)
- Client authentication

## User Registration

```uml
actor "User/Browser" as user
participant Odin as odin
participant "OpenID Provider" as openId
participant "Token endpoint" as getToken
participant "UserInfo endpoint" as userInfo
participant "User Registration Server" as userRegistry
database "User Identities" as usersDb

user -> odin : Selects new account registration
user <- odin : Generates OpenID Connect Authorize request and redirects to OpenID server
user -> openId : Authenticates
user <- openId : Redirects user back to Odin with one-time code
user -> odin : Request authorization with one-time code

odin <-> getToken : Exchange one-time code for access-token
odin <-> userInfo : Use access-token to obtain user-identifier
odin -> odin : Generate 'CA' user certificate with hash of user-identifier + random-key
odin -> userRegistry : Pass access-token, certificate, user-identifer and random-key

userRegistry <-> userInfo : Retrieve user-identifier belonging to session
userRegistry -> userRegistry : Verify user-identifier and certificate

alt authorisation request legitimate
    userRegistry -> userRegistry : Sign certificate
    userRegistry <-> usersDb : Store user-identifier, signed certificate and random-key
    odin <- userRegistry : Pass signed-certificate
    odin -> odin : store signed-certicate and register as login-entrypoint for user
    odin -> odin : [Perform (machine) session creation flow in background]
    user <- odin : Show sign-up successful
else
    odin <- userRegistry : User registration request denied
    user <- odin : User registration request denied
end
```

## Machine

## Authorisation

## Authenticity

## Anonymity

## Limiting exposure